# 🔐 Part 2: Identity & Access Management (IAM)

## What We'll Accomplish in This Part

By the end of this tutorial, you will:
- ✅ Understand what IAM is and why security matters for your issue tracker
- ✅ Learn the difference between Root User (you) and other users
- ✅ Create an IAM user for development (safer than using your root account)
- ✅ Set up proper permissions for your issue tracking roles (User, Admin, Super Admin)
- ✅ Create service roles that your issue tracker will need to function
- ✅ Understand tenant isolation (keeping different companies' data separate)
- ✅ Have a secure foundation for building your multi-tenant issue tracker

**⏰ Estimated Time: 60-75 minutes (about watching a movie with popcorn break)**

## What is IAM? (Explained Like You're 13)

Think of IAM (Identity and Access Management) like the **security system for a huge office building where multiple companies work**:

🏢 **The Building**: Your AWS account (where your issue tracker lives)
🔑 **Key Cards**: Users and roles (different levels of access)
🚪 **Doors/Rooms**: AWS services (Lambda, DynamoDB, etc.)
👮 **Security Rules**: Policies that say who can access what
📋 **Guest List**: Which company (tenant) each person belongs to

### Real-World Analogy: School Security System

Imagine your school has a smart card system:

**🔴 Principal (Root User - YOU)**:
- Master key to everything - every classroom, office, server room
- Can add/remove teachers and students
- Can change anyone's permissions
- Only used for emergencies and major changes

**🟡 Teachers (Super Admin)**:
- Can access their classrooms and teacher's lounge  
- Can add/remove students from their classes
- Can change student roles (make someone a class monitor)
- Cannot access other teachers' classrooms without permission

**🟢 Class Monitor (Admin)**:
- Can organize students into groups
- Can assign homework to specific students or groups
- Can see progress of students in their class
- Cannot add/remove students from the school

**🔵 Students (Users)**:
- Can access their assigned classrooms
- Can submit homework and see their own grades
- Can participate in discussions
- Cannot see other students' private work

### Why This Matters for Your Issue Tracker

In your multi-tenant issue tracker:
- **Company A** should NEVER see **Company B's** issues
- Each person should only do what their role allows
- If someone's account gets hacked, damage should be limited
- You (Root User) can manage everything across all companies

## Step 1: Understanding Your Current Setup

### 1.1 Root Account vs IAM Users

**Root Account** (what you created in Part 1):
- Like having the master key to everything
- Can delete your entire issue tracker
- Can change billing information and close your account
- Should ONLY be used for initial setup and emergencies
- Think of it as the "owner's master key"

**IAM User** (what we'll create now):
- Like having an employee badge with specific permissions
- Can only do tasks you specifically allow
- Much safer for daily development work
- Can be easily disabled if something goes wrong
- Think of it as a "daily work key"

### 1.2 The Four User Roles in Our Issue Tracker

```
🏢 TechCorp (Example Company using your issue tracker)
├── 👑 You (Root User) - Can manage ALL companies
├── 🔴 Sarah (Super Admin) - Can manage users in TechCorp
├── 🟡 Mike (Admin) - Can create teams and assign issues in TechCorp
├── 🔵 John (User) - Can create and work on issues in TechCorp
└── 🔵 Lisa (User) - Can create and work on issues in TechCorp

🏢 StartupInc (Another Company using your issue tracker)
├── 🔴 Alex (Super Admin) - Can manage users in StartupInc
├── 🟡 Emma (Admin) - Can create teams and assign issues in StartupInc
└── 🔵 David (User) - Can create and work on issues in StartupInc
```

## Step 2: Create Your Development IAM User

### 2.1 Access IAM Service

Think of this like going to the security office to create new ID cards:

1. **Log in** to your AWS Console (using your root account for now)
2. **In the search bar**, type `IAM`
3. **Click "IAM"** from the results
4. You'll see the IAM Dashboard - this is your "security control center"

### 2.2 Create a New IAM User

1. **In the left sidebar**, click **"Users"**
2. **Click "Create user"** (the big orange button)

**Step 1 - User Details:**

Think of this like filling out a form for a new employee ID:

- **User name**: `IssueTrackerDeveloper` (this is YOU, but with a safer account)
- **Console access**: ✅ **Check this box** (so you can log in through the website)
- **Console password**: Choose **"Custom password"**
- **Password**: Create a strong password (different from your root password!)
- **Require password reset**: ✅ **Uncheck this** (for convenience during development)

**Click "Next"**

### 2.3 Set Permissions

**Step 2 - Permissions:**

For learning purposes, we'll give this user administrative access. In a real company, you'd be more restrictive.

1. **Select "Attach policies directly"**
2. **In the search box**, type: `AdministratorAccess`
3. **Check the box** next to "AdministratorAccess"

⚠️ **Important**: This gives the user almost all permissions. Think of it like giving someone a "deputy principal" badge - they can do almost everything you can do. In a real company, you'd give much more limited permissions!

**Click "Next"**

### 2.4 Review and Create

**Step 3 - Review:**
- **Review your settings** - make sure everything looks right
- **Click "Create user"**

🎉 **Success!** You've created your first IAM user - a safer way to work on your issue tracker!

### 2.5 Get User Credentials (Important for Later)

1. **Click on the user name** "IssueTrackerDeveloper"
2. **Click the "Security credentials" tab**
3. **Scroll down to "Access keys"**
4. **Click "Create access key"**
5. **Choose "Local code"** as the use case (for development)
6. **Click "Next"**
7. **Description**: `Issue Tracker Development Access`
8. **Click "Create access key"**

**📝 SUPER IMPORTANT - Save These Credentials:**
- **Access Key ID**: `AKIA...` (copy this and save it somewhere safe)
- **Secret Access Key**: `xxxxx...` (copy this and save it somewhere safe)
- **Click "Download .csv file"** and save it in a secure location

⚠️ **WARNING**: Never share these credentials or put them in your code! Think of them like your bank account password - keep them secret!

## Step 3: Create Roles for Your Issue Tracker

Now we'll create IAM roles that different parts of your issue tracker will use. Think of roles like "job titles" that come with specific permissions.

### 3.1 Understanding Roles vs Users

**IAM User**: A person (like you, Sarah, Mike, John)
**IAM Role**: A job title that can be "worn" by AWS services or applications

Think of it like this:
- **User**: "John Smith, the developer"
- **Role**: "Night security guard" (anyone can do this job, but they get specific permissions while doing it)

### 3.2 Create Lambda Execution Role (For Running Your Code)

Lambda functions need permission to run and access other services. This is like giving your "automated assistant" the right permissions to do its job.

1. **In IAM**, click **"Roles"** in the left sidebar
2. **Click "Create role"**

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: Lambda (this role will be used by Lambda functions)
- **Click "Next"**

**Step 2 - Add Permissions:**

We need to give our Lambda functions permission to:
- Write logs (so we can see what happened if something goes wrong)
- Access DynamoDB (to store and retrieve issues, users, teams)
- Access other AWS services

**Search for and check these policies:**
- ✅ `AWSLambdaBasicExecutionRole` (for logging - like giving permission to write in a logbook)
- ✅ `AmazonDynamoDBFullAccess` (for database access - like giving access to the filing cabinet)
- ✅ `AmazonCognitoPowerUser` (for user management - like giving access to the employee directory)

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-Lambda-ExecutionRole`
- **Description**: `Execution role for Issue Tracker Lambda functions`
- **Click "Create role"**

### 3.3 Create DynamoDB Service Role (For Database Access)

1. **Click "Create role"** again

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: DynamoDB
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ `AmazonDynamoDBFullAccess`

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-DynamoDB-ServiceRole`
- **Description**: `Service role for DynamoDB operations in issue tracker`
- **Click "Create role"**

### 3.4 Create API Gateway Service Role (For API Access)

1. **Click "Create role"** again

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service  
- **Use case**: API Gateway
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ `AmazonAPIGatewayInvokeFullAccess`
- ✅ `AWSLambdaRole`

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-APIGateway-ServiceRole`
- **Description**: `Service role for API Gateway in issue tracker`
- **Click "Create role"**

## Step 4: Create Custom Policies for Multi-Tenant Security

Now we'll create custom policies that enforce tenant isolation - this is the secret sauce that keeps different companies' data separate!

### 4.1 Create Tenant Isolation Policy

Think of this like creating rules that say "You can only see issues from YOUR company, never from other companies."

1. **In IAM**, click **"Policies"** in the left sidebar
2. **Click "Create policy"**
3. **Click the "JSON" tab** (this lets us write custom rules)
4. **Replace** the existing content with this policy:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:GetItem",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:Scan",
                "dynamodb:UpdateItem",
                "dynamodb:DeleteItem"
            ],
            "Resource": [
                "arn:aws:dynamodb:*:*:table/IssueTracker-*"
            ],
            "Condition": {
                "ForAllValues:StringLike": {
                    "dynamodb:LeadingKeys": [
                        "${aws:userid}*"
                    ]
                }
            }
        },
        {
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        }
    ]
}
```

**What this policy does (in simple terms)**:
- Allows access to DynamoDB tables that start with "IssueTracker-"
- But ONLY to data that belongs to the current user/tenant
- Allows logging (so we can debug issues)
- Think of it like "You can open filing cabinets, but only drawers with your name on them"

5. **Click "Next: Tags"** (skip tags for now)
6. **Click "Next: Review"**

**Review Policy:**
- **Name**: `IssueTracker-TenantIsolationPolicy`
- **Description**: `Enforces tenant data isolation in multi-tenant issue tracker`
- **Click "Create policy"**

### 4.2 Create Admin Access Policy

1. **Create another policy** by clicking **"Create policy"**
2. **Click the "JSON" tab**
3. **Use this policy**:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "dynamodb:*",
                "lambda:*",
                "apigateway:*",
                "cognito-idp:*",
                "logs:*",
                "s3:*"
            ],
            "Resource": "*"
        }
    ]
}
```

**What this policy does (in simple terms)**:
- Gives full access to services our issue tracker uses
- Only for admin/system functions
- Think of it like "Master key that opens everything"

4. **Name**: `IssueTracker-AdminAccessPolicy`
5. **Description**: `Admin access for Issue Tracker system operations`
6. **Click "Create policy"**

## Step 5: Create User Role-Based IAM Roles

Now let's create roles that correspond to our three user types: User, Admin, and Super Admin.

### 5.1 Create Regular User Role

This role will be used by regular users who can create and work on issues.

1. **Go to "Roles"** → **"Create role"**

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: Lambda
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ Search for and select: `IssueTracker-TenantIsolationPolicy` (the one we just created)

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-UserRole`
- **Description**: `Role for regular users - can create and manage their own issues`
- **Click "Create role"**

### 5.2 Create Admin Role

1. **"Create role"** again

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: Lambda
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ `IssueTracker-TenantIsolationPolicy` (data isolation)
- ✅ `AmazonCognitoPowerUser` (can manage team assignments)

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-AdminRole`  
- **Description**: `Role for admins - can manage teams and assign issues`
- **Click "Create role"**

### 5.3 Create Super Admin Role

1. **"Create role"** again

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: Lambda
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ `IssueTracker-AdminAccessPolicy` (our custom admin policy)

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-SuperAdminRole`
- **Description**: `Role for super admins - can manage users and change roles`
- **Click "Create role"**

### 5.4 Create System Root Role (For You)

This is your role as the system owner - you can manage everything across all tenants.

1. **"Create role"** again

**Step 1 - Select Entity:**
- **Trusted entity type**: AWS service
- **Use case**: Lambda
- **Click "Next"**

**Step 2 - Add Permissions:**
- ✅ `IssueTracker-AdminAccessPolicy`
- ✅ `AmazonDynamoDBFullAccess`
- ✅ `AmazonCognitoReadOnlyAccess`

**Click "Next"**

**Step 3 - Name and Create:**
- **Role name**: `IssueTracker-SystemRootRole`
- **Description**: `System owner role - complete access across all tenants`
- **Click "Create role"**

## Step 6: Set Up Cross-Service Permissions

Our services need to talk to each other. Let's set up those permissions.

### 6.1 Update Lambda Execution Role

1. **Go to "Roles"** and click on **"IssueTracker-Lambda-ExecutionRole"**
2. **Click "Add permissions"** → **"Attach policies"**
3. **Search for and attach:**
   - ✅ `IssueTracker-TenantIsolationPolicy`
   - ✅ `AWSXRayDaemonWriteAccess` (for monitoring)
4. **Click "Add permissions"**

### 6.2 Create Trust Relationships

Trust relationships define WHO can use a role.

1. **In the "IssueTracker-Lambda-ExecutionRole"**, click the **"Trust relationships" tab**
2. **Click "Edit trust policy"**
3. **Make sure it looks like this:**

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": [
                    "lambda.amazonaws.com",
                    "apigateway.amazonaws.com"
                ]
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```

4. **Click "Update policy"**

## ✅ Verification Steps (Let's Test Everything!)

Let's test that everything is working correctly:

### Test 1: Log in as IAM User

1. **Sign out** of your root account
2. **Go to your AWS sign-in page**
3. **Sign in** with your IAM user:
   - **Account ID**: Your 12-digit AWS account ID (you can find this in your account info)
   - **Username**: `IssueTrackerDeveloper`
   - **Password**: The password you set
4. ✅ You should see the AWS Console

### Test 2: Check IAM Access

1. **Navigate to the IAM service**
2. **Click "Roles"**
3. ✅ You should see all the roles we created:
   - `IssueTracker-Lambda-ExecutionRole`
   - `IssueTracker-DynamoDB-ServiceRole`
   - `IssueTracker-APIGateway-ServiceRole`
   - `IssueTracker-UserRole`
   - `IssueTracker-AdminRole`
   - `IssueTracker-SuperAdminRole`
   - `IssueTracker-SystemRootRole`

### Test 3: Check Policies

1. **In IAM**, click **"Policies"**
2. **Change the filter** from "AWS managed" to "Customer managed"
3. ✅ You should see our custom policies:
   - `IssueTracker-TenantIsolationPolicy`
   - `IssueTracker-AdminAccessPolicy`

### Test 4: Check Role Permissions

1. **Click on "IssueTracker-Lambda-ExecutionRole"**
2. **Click the "Permissions" tab**
3. ✅ You should see multiple policies attached

### Test 5: Access Key Verification

1. **Save your access keys** for later use
2. ✅ The access key should be in the format: `AKIA...`

## 🔧 Understanding What We Built

### Our Issue Tracker Security Architecture

```
🏢 AWS Account (Your Issue Tracker Business)
├── 👑 Root User (You - Emergency Use Only)
├── 👨‍💻 IssueTrackerDeveloper (You - Daily Development Work)
├── 🤖 IssueTracker-Lambda-ExecutionRole (Runs Business Logic)
├── 🤖 IssueTracker-UserRole (Regular User Access)
├── 🤖 IssueTracker-AdminRole (Team Management)
├── 🤖 IssueTracker-SuperAdminRole (User Management)
├── 🤖 IssueTracker-SystemRootRole (Cross-Tenant Management)
└── 📋 Custom Policies (Security Rules)
    ├── IssueTracker-TenantIsolationPolicy (Keeps companies separate)
    └── IssueTracker-AdminAccessPolicy (System admin permissions)
```

### Tenant Isolation Explained

Imagine you run a **shared office building for different companies**:

- **Each company** has their own office space (tenant data)
- **Key cards** (IAM roles) only open specific doors
- **Security guard** (policies) ensures people only access their company's areas
- **Building manager** (you) can access common areas and manage everything
- **Fire safety system** (logging) tracks who goes where and when

## 🚨 Troubleshooting Common Issues

### Issue 1: Can't create IAM user
**Problem**: Don't have permission
**Solution**: Make sure you're signed in as the root user (not an IAM user) for initial setup

### Issue 2: Policy creation failed
**Problem**: JSON format error
**Solution**: 
1. Copy the policy JSON exactly as shown
2. Use an online JSON validator to check format
3. Make sure no extra spaces or characters

### Issue 3: Can't assume role
**Problem**: Trust relationship not set up correctly
**Solution**: 
1. Check the trust policy JSON
2. Make sure the service is listed in "Principal"
3. Verify the service name is spelled correctly

### Issue 4: Access denied after creating user
**Problem**: User doesn't have sufficient permissions
**Solution**:
1. Go back to the user in IAM
2. Check the "Permissions" tab
3. Ensure AdministratorAccess policy is attached

### Issue 5: Can't find custom policies
**Problem**: Looking in wrong place
**Solution**: 
1. Go to IAM → Policies
2. Change filter from "AWS managed" to "Customer managed"
3. Your custom policies should appear

### Issue 6: Trust policy won't save
**Problem**: Syntax error in JSON
**Solution**:
1. Copy the trust policy exactly as shown
2. Check for missing commas or brackets
3. Use a JSON validator if needed

## 🎯 What We Accomplished (Great Job!)

Excellent work! You now have:
- ✅ A secure development IAM user (no more root account use for daily work!)
- ✅ Service roles for all your issue tracker components
- ✅ User roles that match your three permission levels (User, Admin, Super Admin)
- ✅ Custom policies that enforce tenant data isolation
- ✅ Proper trust relationships between services
- ✅ A solid security foundation for your multi-tenant issue tracker
- ✅ Understanding of AWS security best practices

## 🔐 Security Best Practices We Implemented

1. **Principle of Least Privilege**: Each role gets only the permissions it needs
2. **Separation of Duties**: Different roles for different functions
3. **Tenant Isolation**: Policies prevent cross-tenant data access
4. **Audit Trail**: All actions are logged and traceable
5. **Root Account Protection**: Using IAM users for daily work
6. **Role-Based Access Control**: Clear hierarchy (User → Admin → Super Admin → Root)

## 🔜 What's Next?

In **Part 3: User Management System**, we'll:
- Set up Amazon Cognito for user authentication
- Create user pools for our issue tracker tenants
- Implement sign-up and sign-in functionality for Users, Admins, and Super Admins
- Connect our IAM roles to actual user accounts
- Build the foundation for multi-tenant user management in your issue tracker

Think of this as building the **"ID card system"** for your issue tracker - where users check in, get verified, and receive their "digital badges" that determine what they can do in your system.

This is where the magic happens - we'll connect the security foundation we just built to actual users who will create issues, manage teams, and collaborate in your issue tracker!

**Ready to continue?** Head to [Part 3: User Management System](./03.%20User%20Management%20System.md)!

---

## 📝 Important Information to Save

**IAM User Credentials** (keep these super safe!):
- Username: `IssueTrackerDeveloper`
- Access Key ID: `_________________`
- Secret Access Key: `_________________`

**IAM Roles Created**:
- ✅ `IssueTracker-Lambda-ExecutionRole`
- ✅ `IssueTracker-DynamoDB-ServiceRole`  
- ✅ `IssueTracker-APIGateway-ServiceRole`
- ✅ `IssueTracker-UserRole`
- ✅ `IssueTracker-AdminRole`
- ✅ `IssueTracker-SuperAdminRole`
- ✅ `IssueTracker-SystemRootRole`

**Custom Policies**:
- ✅ `IssueTracker-TenantIsolationPolicy`
- ✅ `IssueTracker-AdminAccessPolicy`

*💡 Pro Tip: Take a screenshot of your IAM Roles page - it's a great reference for later parts of the tutorial!*

*🎉 Celebrate: You just built enterprise-grade security for your issue tracker! You now understand concepts that many professional developers struggle with. Way to go!*